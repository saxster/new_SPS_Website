---
/**
 * Newsletter Signup Component
 *
 * A brutalist-styled newsletter subscription form with sector preferences.
 * Submits to /api/newsletter endpoint or configurable external service.
 */

interface Props {
  variant?: 'inline' | 'card' | 'minimal';
  showSectorPrefs?: boolean;
  class?: string;
}

const { variant = 'card', showSectorPrefs = false, class: className = '' } = Astro.props;

const sectors = [
  { id: 'jewellery', label: 'Jewellery & High Value' },
  { id: 'education', label: 'Education' },
  { id: 'healthcare', label: 'Healthcare' },
  { id: 'finance', label: 'SME Finance' },
  { id: 'cyber', label: 'Cyber Defence' },
  { id: 'corporate', label: 'Corporate Security' },
  { id: 'industrial', label: 'Industrial & Manufacturing' },
  { id: 'retail', label: 'Retail & Commercial' },
  { id: 'hospitality', label: 'Hospitality' },
  { id: 'residential', label: 'Residential' },
];

const wrapperClass = {
  inline: 'flex flex-col sm:flex-row gap-4',
  card: 'brutalist-card p-6 md:p-8 bg-neutral-900 border-neutral-700',
  minimal: '',
}[variant];
---

<div class:list={[wrapperClass, className]} id="newsletter-form-wrapper">
  {variant === 'card' && (
    <div class="mb-6">
      <h3 class="text-xl font-bold text-white mb-2">INTELLIGENCE BRIEFING</h3>
      <p class="text-sm text-neutral-400 mb-3">
        Join security professionals across India. Every week, receive curated threat intelligence, compliance updates, and sector-specific advisories from our Intelligence Team.
      </p>
      <div class="flex items-center gap-4 text-xs text-neutral-500">
        <span class="flex items-center gap-1">
          <svg class="w-3 h-3 text-success" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg>
          Weekly delivery
        </span>
        <span class="flex items-center gap-1">
          <svg class="w-3 h-3 text-success" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg>
          No spam
        </span>
        <span class="flex items-center gap-1">
          <svg class="w-3 h-3 text-success" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg>
          Unsubscribe anytime
        </span>
      </div>
    </div>
  )}

  <form
    id="newsletter-form"
    class={variant === 'inline' ? 'flex flex-col sm:flex-row gap-4 w-full' : 'space-y-4'}
    action="/api/newsletter"
    method="POST"
  >
    <div class={variant === 'inline' ? 'flex-1' : ''}>
      <label for="newsletter-email" class="sr-only">Email address</label>
      <input
        type="email"
        id="newsletter-email"
        name="email"
        required
        placeholder="Enter your email address"
        class="w-full bg-black border-2 border-neutral-700 text-white p-3 text-sm focus:border-primary-accent focus:outline-none placeholder-neutral-500 uppercase tracking-wide"
        aria-describedby="newsletter-status"
      />
    </div>

    {showSectorPrefs && variant !== 'inline' && (
      <details class="group">
        <summary class="text-xs font-bold text-neutral-500 uppercase tracking-widest mb-2 cursor-pointer hover:text-primary-accent transition-colors flex items-center gap-2 select-none">
          <span>Customize Preferences (Optional)</span>
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-3 h-3 transition-transform group-open:rotate-180">
            <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
          </svg>
        </summary>
        <fieldset class="space-y-3 mt-3 animate-fade-in-up">
          <div class="grid grid-cols-2 gap-2">
            {sectors.map((sector) => (
              <label class="flex items-center gap-2 text-sm text-neutral-300 cursor-pointer hover:text-primary-accent transition-colors">
                <input
                  type="checkbox"
                  name="sectors"
                  value={sector.id}
                  class="accent-primary-accent"
                />
                {sector.label}
              </label>
            ))}
          </div>
        </fieldset>
      </details>
    )}

    <button
      type="submit"
      class={`brutalist-button brutalist-button--primary ${variant === 'inline' ? 'whitespace-nowrap' : 'w-full'}`}
    >
      SUBSCRIBE
    </button>

    <div
      id="newsletter-status"
      class="hidden text-sm p-3 border-2"
      role="alert"
      aria-live="polite"
    ></div>
  </form>

  {variant === 'card' && (
    <p class="text-xs text-neutral-600 mt-4">
      Your data is protected. Unsubscribe anytime. Read our <a href="/privacy" class="text-primary-accent hover:underline">Privacy Policy</a>.
    </p>
  )}
</div>

<script>
  const form = document.getElementById('newsletter-form') as HTMLFormElement;
  const statusEl = document.getElementById('newsletter-status');
  const wrapper = document.getElementById('newsletter-form-wrapper');

  if (form && statusEl) {
    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      const submitBtn = form.querySelector('button[type="submit"]') as HTMLButtonElement;
      const originalText = submitBtn.textContent;
      submitBtn.textContent = 'PROCESSING...';
      submitBtn.disabled = true;

      try {
        const formData = new FormData(form);
        const data = {
          email: formData.get('email'),
          sectors: formData.getAll('sectors'),
        };

        const response = await fetch('/api/newsletter', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data),
        });

        const result = await response.json();

        statusEl.classList.remove('hidden', 'border-red-500/50', 'text-red-300', 'bg-red-900/20');
        statusEl.classList.remove('border-emerald-500/50', 'text-emerald-300', 'bg-emerald-900/20');

        if (response.ok) {
          statusEl.classList.add('border-emerald-500/50', 'text-emerald-300', 'bg-emerald-900/20');
          statusEl.textContent = result.message || 'Successfully subscribed to intelligence briefings.';
          form.reset();
          
          // Track Event
          if ((window as any).plausible) {
              (window as any).plausible('Newsletter Signup', { 
                  props: { 
                      sectors: data.sectors.join(','),
                      location: 'Form Component' 
                  } 
              });
          }
        } else {
          statusEl.classList.add('border-red-500/50', 'text-red-300', 'bg-red-900/20');
          statusEl.textContent = result.error || 'Subscription failed. Please try again.';
        }
      } catch (error) {
        statusEl.classList.remove('hidden');
        statusEl.classList.add('border-red-500/50', 'text-red-300', 'bg-red-900/20');
        statusEl.textContent = 'Connection error. Please check your network and try again.';
      } finally {
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
      }
    });
  }
</script>
