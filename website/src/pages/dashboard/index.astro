---
import DashboardLayout from '../../layouts/DashboardLayout.astro';
import ThreatBriefing from '../../components/dashboard/ThreatBriefing';
import SectorPreferences from '../../components/dashboard/SectorPreferences';
import { getCollection } from 'astro:content';

// Force server-side rendering for this page
export const prerender = false;

// Get latest articles for threat briefing
const allArticles = await getCollection('blog');
const latestArticles = allArticles
  .sort((a, b) => new Date(b.data.publishedAt).getTime() - new Date(a.data.publishedAt).getTime())
  .slice(0, 10);

// Get all sectors
const allSectors = await getCollection('sectors');
const sectorsList = allSectors.map(s => ({
  slug: s.slug,
  name: s.data.title,
  icon: s.data.icon || 'shield'
}));
---

<DashboardLayout activeTab="overview">
  <div class="space-y-8">
    <!-- Welcome Section -->
    <section class="bg-neutral-900 border-2 border-neutral-800 p-6">
      <div class="flex items-start justify-between">
        <div>
          <h2 class="text-2xl font-black text-neutral-100 mb-2">THREAT INTELLIGENCE BRIEFING</h2>
          <p class="text-neutral-400 text-sm font-mono">
            Personalized intelligence based on your sector preferences
          </p>
        </div>
        <div class="text-right">
          <p class="text-xs text-neutral-500 font-mono">LAST UPDATE</p>
          <p class="text-sm text-primary-accent font-mono">
            {new Date().toLocaleDateString('en-IN', { day: '2-digit', month: 'short', year: 'numeric' })}
          </p>
        </div>
      </div>
    </section>

    <!-- Main Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
      <!-- Left: Threat Briefing (2 cols) -->
      <div class="lg:col-span-2 space-y-6">
        <ThreatBriefing
          client:load
          articles={latestArticles.map(a => ({
            slug: a.slug,
            title: a.data.title,
            description: a.data.description,
            sector: a.data.sector,
            publishedAt: a.data.publishedAt.toISOString(),
            contentType: a.data.contentType
          }))}
        />
      </div>

      <!-- Right: Sector Preferences (1 col) -->
      <div class="space-y-6">
        <SectorPreferences
          client:load
          sectors={sectorsList}
        />

        <!-- Quick Stats -->
        <div class="bg-neutral-900 border-2 border-neutral-800 p-6">
          <h3 class="text-sm font-bold text-neutral-400 uppercase tracking-wider mb-4">
            Quick Stats
          </h3>
          <div class="space-y-4">
            <div class="flex items-center justify-between">
              <span class="text-sm text-neutral-500">Saved Articles</span>
              <span class="text-lg font-bold text-primary-accent">0</span>
            </div>
            <div class="flex items-center justify-between">
              <span class="text-sm text-neutral-500">Expert Sessions</span>
              <span class="text-lg font-bold text-primary-accent">0</span>
            </div>
            <div class="flex items-center justify-between">
              <span class="text-sm text-neutral-500">Sectors Tracked</span>
              <span class="text-lg font-bold text-primary-accent">0</span>
            </div>
          </div>
        </div>

        <!-- Ask Expert CTA -->
        <div class="bg-gradient-to-br from-primary-accent/20 to-primary-accent/5 border-2 border-primary-accent/30 p-6">
          <h3 class="text-lg font-bold text-primary-accent mb-2">
            NEED INTEL ANALYSIS?
          </h3>
          <p class="text-sm text-neutral-400 mb-4">
            Get instant answers from our AI-powered security expert.
          </p>
          <a
            href="/#ask-expert"
            class="inline-flex items-center gap-2 bg-primary-accent text-black px-4 py-2 font-bold text-sm uppercase tracking-wider hover:bg-primary-accent/80 transition-colors"
          >
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
            </svg>
            Ask Expert
          </a>
        </div>
      </div>
    </div>
  </div>
</DashboardLayout>
