---
import { getCollection } from 'astro:content';
import Layout from '../../layouts/Layout.astro';
import SideDrawer from '../../components/SideDrawer.astro';

export async function getStaticPaths() {
  const sectors = await getCollection('sectors');
  return sectors.map(entry => ({
    params: { slug: entry.slug }, props: { entry },
  }));
}

const { entry } = Astro.props;
const { Content } = await entry.render();

// Fetch latest Intelligence related to this sector (Mock logic for now, or match tags)
const allPosts = await getCollection('blog');
const relatedPosts = allPosts.filter(post =>
    post.data.category === entry.data.title.split(' ')[0] ||
    (post.data.tags && post.data.tags.some(tag => entry.data.title.toLowerCase().includes(tag)))
).slice(0, 3);

// Breadcrumbs for this sector page
const breadcrumbs = [
  { name: 'Home', url: '/' },
  { name: 'Sectors', url: '/sectors' },
  { name: entry.data.title, url: `/sectors/${entry.slug}` }
];
---

<Layout title={`${entry.data.title} Security | SPS Intelligence`} description={entry.data.description} breadcrumbs={breadcrumbs}>
  <SideDrawer />
  
  <section class="brutalist-section pt-32 pb-16 min-h-[50vh] flex items-center">
    <div class="brutalist-container">
      <div class="max-w-4xl">
        <div class="text-8xl mb-8">{entry.data.icon}</div>
        <h1 class="text-heading-1 mb-6 text-primary-accent">{entry.data.title.toUpperCase()}</h1>
        <p class="text-2xl text-body font-medium leading-relaxed max-w-3xl">
            {entry.data.description}
        </p>
      </div>
    </div>
  </section>

  <!-- Risk & Regulations Grid -->
  <section class="brutalist-section brutalist-section--dark py-20">
    <div class="brutalist-container">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-16">
            
            <!-- Risks -->
            {entry.data.risks && entry.data.risks.length > 0 && (
            <div>
                <h2 class="text-3xl font-black text-critical mb-8 uppercase tracking-widest flex items-center gap-3">
                    <span class="w-3 h-3 bg-critical inline-block"></span>
                    Critical Risks
                </h2>
                <ul class="space-y-4">
                    {entry.data.risks.map(risk => (
                        <li class="flex items-start gap-3 text-lg border-b border-neutral-800 pb-4">
                            <span class="text-critical text-xl">⚠️</span>
                            {risk}
                        </li>
                    ))}
                </ul>
            </div>
            )}

            <!-- Regulations -->
            {entry.data.regulations && entry.data.regulations.length > 0 && (
            <div>
                <h2 class="text-3xl font-black text-compliance mb-8 uppercase tracking-widest flex items-center gap-3">
                    <span class="w-3 h-3 bg-compliance inline-block"></span>
                    Key Regulations
                </h2>
                <ul class="space-y-4">
                    {entry.data.regulations.map(reg => (
                        <li class="flex items-start gap-3 text-lg border-b border-neutral-800 pb-4">
                            <span class="text-compliance text-xl">⚖️</span>
                            {reg}
                        </li>
                    ))}
                </ul>
            </div>
            )}

        </div>
    </div>
  </section>

  <!-- Detailed Content -->
  <section class="brutalist-section py-20">
    <div class="brutalist-container max-w-4xl">
        <div class="prose prose-lg prose-invert max-w-none
          prose-headings:font-black prose-headings:uppercase prose-headings:text-white
          prose-headings:tracking-tight prose-headings:border-b prose-headings:border-neutral-800
          prose-headings:pb-2 prose-headings:mb-4
          prose-h2:text-2xl prose-h2:mt-12 prose-h3:text-xl prose-h3:mt-8
          prose-p:text-neutral-300 prose-p:leading-relaxed prose-p:mb-4
          prose-a:text-primary-accent prose-a:no-underline hover:prose-a:underline
          prose-blockquote:border-l-4 prose-blockquote:border-primary-accent
          prose-blockquote:bg-neutral-900 prose-blockquote:p-4 prose-blockquote:text-white
          prose-blockquote:not-italic prose-blockquote:my-6
          prose-li:text-neutral-300 prose-strong:text-white
          prose-code:bg-neutral-800 prose-code:text-primary-accent prose-code:px-1.5
          prose-code:py-0.5 prose-code:rounded prose-code:font-mono prose-code:text-sm
          prose-code:before:content-none prose-code:after:content-none
          prose-pre:bg-neutral-900 prose-pre:border prose-pre:border-neutral-800
          prose-pre:rounded-none prose-pre:p-4 prose-pre:overflow-x-auto
          prose-table:border-collapse prose-table:w-full prose-table:my-6
          prose-th:bg-neutral-900 prose-th:text-white prose-th:font-black prose-th:uppercase
          prose-th:text-left prose-th:p-3 prose-th:border prose-th:border-neutral-700
          prose-td:p-3 prose-td:border prose-td:border-neutral-800 prose-td:text-neutral-300
          prose-tr:even:bg-neutral-900/50
          prose-img:border-2 prose-img:border-neutral-800 prose-img:my-8 prose-img:mx-auto
          prose-figure:my-8 prose-figcaption:text-center prose-figcaption:text-neutral-500
          prose-figcaption:text-sm prose-figcaption:mt-2
          prose-hr:border-neutral-800 prose-hr:border-t-2 prose-hr:my-12
          prose-ul:my-4 prose-ul:pl-6 prose-ol:my-4 prose-ol:pl-6
          prose-li:my-1 prose-li:marker:text-primary-accent
        ">
            <Content />
        </div>
    </div>
  </section>

  {relatedPosts.length > 0 && (
      <section class="brutalist-section brutalist-section--dark pt-20">
        <div class="brutalist-container">
            <h2 class="text-heading-2 mb-12">RELATED INTELLIGENCE</h2>
            <div class="brutalist-grid brutalist-grid--3">
                {relatedPosts.map(post => (
                    <article class="brutalist-card group">
                        <h3 class="text-article-title mb-3 group-hover:text-primary-accent transition-colors">
                            <a href={`/articles/${post.slug}`}>{post.data.title}</a>
                        </h3>
                        <p class="text-sm text-neutral-400">{post.data.description}</p>
                    </article>
                ))}
            </div>
        </div>
      </section>
  )}

</Layout>
