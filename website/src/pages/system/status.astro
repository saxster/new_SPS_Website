---
import Layout from '../../layouts/Layout.astro';
import SideDrawer from '../../components/SideDrawer.astro';

// This page is SSR only to show live system status
export const prerender = false;

let systemStatus = {
    agents: { CCO: 'OFFLINE', Miner: 'OFFLINE', Analyst: 'OFFLINE', RedTeam: 'OFFLINE' },
    recent_logs: [],
    api_status: 'DISCONNECTED'
};

try {
    const res = await fetch('http://127.0.0.1:8000/system/status');
    if (res.ok) {
        systemStatus = await res.json();
        systemStatus.api_status = 'OPERATIONAL';
    }
} catch (e) {
    console.error('System status fetch failed:', e);
}
---

<Layout title="System Status | SPS SOC" description="Live status of the SPS Autonomous Intelligence Agents.">
  <SideDrawer />

  <section class="brutalist-section pt-32 pb-20 min-h-screen bg-[#050505]">
    <div class="brutalist-container pl-20 max-w-6xl">
      <div class="mb-12 border-b border-neutral-800 pb-8 flex justify-between items-end">
        <div>
            <h1 class="text-heading-1 text-white mb-4 tracking-tighter">SOC COMMAND</h1>
            <p class="text-xl text-primary-accent font-mono uppercase tracking-widest">
              // AUTONOMOUS AGENT MESH STATUS
            </p>
        </div>
        <div class="text-right font-mono">
            <div class={`text-sm ${systemStatus.api_status === 'OPERATIONAL' ? 'text-success' : 'text-critical'}`}>
                BRAIN API: {systemStatus.api_status}
            </div>
            <div class="text-[10px] text-neutral-500">REFRESH_RATE: 5000MS</div>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-12">
        {Object.entries(systemStatus.agents).map(([agent, status]) => (
            <div class="bg-neutral-900 border border-neutral-800 p-6 rounded-sm">
                <div class="text-[10px] text-neutral-500 uppercase tracking-widest mb-2 font-bold">{agent} AGENT</div>
                <div class="flex items-center gap-3">
                    <div class={`w-3 h-3 rounded-full animate-pulse ${status === 'IDLE' ? 'bg-success' : status === 'BUSY' ? 'bg-primary-accent' : 'bg-neutral-700'}`}></div>
                    <div class="text-xl font-black text-white">{status}</div>
                </div>
            </div>
        ))}
      </div>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
          <div class="md:col-span-2">
              <h2 class="text-xs font-black text-neutral-500 uppercase tracking-widest mb-4">LIVE TELEMETRY LOGS</h2>
              <div class="bg-black border border-neutral-800 p-4 font-mono text-xs h-[400px] overflow-y-auto scrollbar-thin">
                  {systemStatus.recent_logs.length > 0 ? (
                      systemStatus.recent_logs.map(log => (
                          <div class="mb-1 py-1 border-b border-neutral-900 last:border-0">
                              <span class="text-primary-accent mr-2">>>></span>
                              <span class="text-neutral-300">{log}</span>
                          </div>
                      ))
                  ) : (
                      <div class="text-neutral-700 italic">No telemetry data received from Brain API...</div>
                  )}
              </div>
          </div>

          <div class="space-y-6">
              <div>
                  <h2 class="text-xs font-black text-neutral-500 uppercase tracking-widest mb-4">SYSTEM CONTROLS</h2>
                  <div class="space-y-2">
                      <button class="w-full p-4 bg-neutral-900 border border-neutral-700 text-xs font-bold text-white hover:bg-primary-accent hover:text-black transition-all text-left flex justify-between items-center group">
                          REBOOT AGENT MESH
                          <span class="opacity-0 group-hover:opacity-100">â†º</span>
                      </button>
                      <button class="w-full p-4 bg-neutral-900 border border-neutral-700 text-xs font-bold text-white hover:bg-primary-accent hover:text-black transition-all text-left flex justify-between items-center group">
                          TRIGGER NEWS PATROL
                          <span class="opacity-0 group-hover:opacity-100">ðŸ“¡</span>
                      </button>
                      <button class="w-full p-4 bg-red-900/20 border border-red-900/50 text-xs font-bold text-red-500 hover:bg-red-500 hover:text-white transition-all text-left flex justify-between items-center group">
                          EMERGENCY HALT
                          <span class="opacity-0 group-hover:opacity-100">ðŸ›‘</span>
                      </button>
                  </div>
              </div>

              <div class="p-6 bg-primary-accent/5 border border-primary-accent/20 rounded">
                  <h3 class="text-xs font-black text-primary-accent uppercase tracking-widest mb-2">n8n ORCHESTRATION</h3>
                  <p class="text-xs text-neutral-400 leading-relaxed font-mono">
                    System is currently tethered to local n8n instance at port 5678. 
                    Autonomic response is ACTIVE for Critical Industrial Hazards.
                  </p>
              </div>
          </div>
      </div>
    </div>
  </section>
</Layout>
